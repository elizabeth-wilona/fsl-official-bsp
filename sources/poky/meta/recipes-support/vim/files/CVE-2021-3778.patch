From 9ba62f1042513fcadcc4e8fdcee171db66ef1d69 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 24 Sep 2021 15:15:24 +0800
Subject: [PATCH] patch 8.2.3409: reading beyond end of line with invalid utf-8
 character

Problem:    Reading beyond end of line with invalid utf-8 character.
Solution:   Check for NUL when advancing.

Upstream-Status: Backport [https://github.com/vim/vim/commit/65b605665997fad54ef39a93199e305af2fe4d7f]
CVE: CVE-2021-3778

Signed-off-by: Mingli Yu <mingli.yu@windriver.com>
---
 src/regexp_nfa.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/regexp_nfa.c b/src/regexp_nfa.c
index fb512f961..2806408de 100644
--- a/src/regexp_nfa.c
+++ b/src/regexp_nfa.c
@@ -5455,7 +5455,8 @@ find_match_text(colnr_T startcol, int regstart, char_u *match_text)
 		match = FALSE;
 		break;
 	    }
-	    len2 += MB_CHAR2LEN(c2);
+	    len2 += enc_utf8 ? utf_ptr2len(rex.line + col + len2)
+	                                                     : MB_CHAR2LEN(c2);
 	}
 	if (match
 		// check that no composing char follows
-- 
2.17.1

